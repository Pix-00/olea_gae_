<html>

<head>
    <script type="text/javascript">
        function addStaff() {
            var uid = prompt("uid:");
            if (uid == "" || uid == null) {
                return;
            }
            var job = prompt("分工:");
            if (job == "" || job == null) {
                return;
            }
            document.getElementById("opt").value = "A";
            document.getElementById("uid").value = uid;
            document.getElementById("data").value = job;
            document.getElementById("form").submit()
        }

        function finishJob(uid) {
            document.getElementById("opt").value = "F";
            document.getElementById("uid").value = uid;
            document.getElementById("form").submit()
        }

        function setReq() {
            var req = prompt("所需人数:");
            if (req == null) {
                return;
            }
            var rePattern = /^[\d]+$/;
            if (!rePattern.test(req)) {
                alert("! 输入无效 请输入一个非负整数 !");
                return;
            }
            document.getElementById("opt").value = "R";
            document.getElementById("data").value = req;
            document.getElementById("form").submit()
        }

        function editJob(uid) {
            var job = prompt("分工:");
            if (job == "" || job == null) {
                return;
            }
            document.getElementById("opt").value = "E";
            document.getElementById("uid").value = uid;
            document.getElementById("data").value = job;
            document.getElementById("form").submit();
        }

        function deleteStaff(event) {
            event.preventDefault();
            var uid = event.dataTransfer.getData("Text");
            if (!confirm("确定要从项目中删除 "+uid+" 吗?")) {
                return;
            }
            document.getElementById("opt").value = "D";
            document.getElementById("uid").value = uid;
            document.getElementById("form").submit();
        }

        function dragOver(event) {
            event.preventDefault();
            document.getElementById("delbox").style.color = "white";
            document.getElementById("delbox").style.background = "red";
        }

        function dragLeave(event) {
            document.getElementById("delbox").style.color = "red";
            document.getElementById("delbox").style.background = "white";
        }

        function dragStart(event) {
            event.dataTransfer.effectAllowed = "move"
            document.getElementById("optbox").style.display = "none";
            document.getElementById("delbox").style.display = "block";
            event.dataTransfer.setData("Text", event.target.id);
        }

        function dragEnd(event) {
            document.getElementById("optbox").style.display = "grid";
            document.getElementById("delbox").style.display = "none";
        }
    </script>

    <style type="text/css">
        body {
            font-size: 12pt;
            margin: 0;
            word-wrap: break-word;
            color: #444;
        }

        table {
            table-layout: fixed;
            width: 100%;
        }

        th {
            height: 40pt;
            color: #333;
            font-size: 14pt;
            font-weight: normal;
        }

        td {
            vertical-align: middle;
            padding: 4pt;
        }

        table,
        th,
        td {
            border: 1pt solid #bbb;
            border-collapse: collapse;
        }

        name {
            color: #282828;
            font-size: 19pt;
        }

        note {
            margin: 15pt 0 24pt 0;
        }

        name,
        note {
            text-align: center;
            display: block;
        }

        button {
            border: 1.5pt solid lightskyblue;
            border-radius: 11pt;
            font-size: 16pt;
            transition-duration: 0.5s;
            cursor: pointer;
            color: rgb(75, 186, 255);
            background-color: white;
        }

        button:disabled {
            border: 1.5pt dashed lightskyblue;
            cursor: no-drop;
        }

        button:hover {
            background-color: lightskyblue;
            color: white;
        }

        button:hover:disabled {
            background-color: white;
            color: white;
        }

        .fj {
            font-size: 12pt;
            border: 1.5pt solid lightsalmon;
            color: salmon;
        }

        .fj:hover {
            background-color: lightsalmon;
        }

        outer {
            border: 2.4pt solid plum;
            border-radius: 15pt;
            width: 570pt;
            padding: 18pt;
            margin: 30pt auto;
            display: block;
        }

        inner {
            border: 1.2pt dashed #bbb;
            border-radius: 8pt;
            padding: 12pt;
            display: block;
        }

        optbox {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 10pt;
            height: 35pt;
            margin: 10pt 0 0 0;
        }

        #delbox {
            display: none;
            border-radius: 12pt;
            text-align: center;
            height: 100pt;
            line-height: 100pt;
            margin: 10pt 0 0 0;
            font-size: 24pt;
            border: 2pt dashed red;
            color: red;
        }
    </style>
</head>

<body>
    <p style="text-align: center; font-size: 18pt; color: pink; margin: 30pt auto;"> 管理专用 ヾ(≧O≦)〃嗷~ </p>
    {% if message %}
    <p style="text-align: center; font-size: 18pt; color: red; margin: 30pt auto;">{{message}}</p>
    {% endif %}
    <outer>
        <name>{{name}}</name>
        <note>{{note}}</note>
        <inner>
            <table>
                <tr>
                    <th style="width:45pt">uid</th>
                    <th style="width:100pt">人员({{ rows | length }}人)</th>
                    <th style="width:350pt">分工</th>
                    <th>交稿</th>
                </tr>
                {% for row in rows %}
                <tr>
                    <td style="text-align:center">{{row.uid}}</td>
                    <td id="{{row.uid}}" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)">{{row.u}}</td>
                    <td onclick="editJob('{{row.uid}}')">{{row.j}}</td>
                    {% if row.f %}
                    <td style="text-align:center">◯</td>
                    {% else %}
                    <td style="text-align:center"><button class='fj' onclick="finishJob('{{row.uid}}')">⌾</button></td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% for j in empty %}
                <tr>
                    <td colspan="4" style="text-align:center;color:#aaa"><I>------　缺人　------</I></td>
                </tr>
                {% endfor %}
            </table>
            <div id="delbox" ondrop="deleteStaff(event)" ondragover="dragOver(event)" ondragleave="dragLeave(event)">拖放以从项目中删除该人员</div>
            <optbox id="optbox">
                <button onclick="addStaff()" {% if not empty %} disabled {% endif %}>接稿</button>
                <button onclick="setReq()">设定人数</button>
            </optbox>
        </inner>
    </outer>

    <form method='post' id="form">
        {% csrf_token %}
        <input type="hidden" name="i" value="{{i.p}},{{i.s}},1">
        <input type="hidden" id="opt" name="opt">
        <input type="hidden" id="uid" name="uid">
        <input type="hidden" id="data" name="data">
    </form>
</body>

</html>
